# ---
# Global ARGs for FROM statements
# This needs to be declared in the global scope otherwise the build will fail in Docker & Podman.
# Docker:
#   WARNING: UndefinedArgInFrom - https://docs.docker.com/go/dockerfile/rule/undefined-arg-in-from/
#   FROM argument 'BASE_IMAGE' is not declared
# Podman: Error: determining starting point for build: no FROM statement found
# ---
ARG BASE_IMAGE=gcr.io/distroless/base-nossl-debian13:latest

# ---
# Stage 1: Install certs, build binary, create default config file
# ---
FROM --platform=$BUILDPLATFORM ghcr.io/project-zot/golang:1.25 AS builder

ARG TARGETOS
ARG TARGETARCH
ARG COMMIT

RUN apt-get update && apt-get install -y git make ca-certificates
RUN mkdir -p /go/src/github.com/project-zot/zot
WORKDIR /go/src/github.com/project-zot/zot
COPY . .
RUN make COMMIT=$COMMIT OS=$TARGETOS ARCH=$TARGETARCH clean binary
RUN echo '# Default config file for zot server\n\
http:\n\
  address: 0.0.0.0\n\
  port: 5000\n\
storage:\n\
  rootDirectory: /var/lib/registry\n\
  gc: false\n\
  dedupe: false' > config.yaml && cat config.yaml

# ---
# Stage 2: Final image with nothing but certs, binary, and default config file
# ---
FROM $BASE_IMAGE AS final
ARG TARGETOS
ARG TARGETARCH
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt
COPY --from=builder /go/src/github.com/project-zot/zot/bin/zot-$TARGETOS-$TARGETARCH /usr/bin/zot
COPY --from=builder /go/src/github.com/project-zot/zot/config.json /etc/zot/config.json
ENTRYPOINT ["/usr/bin/zot"]
EXPOSE 5000
CMD ["serve", "/etc/zot/config.yaml"]
